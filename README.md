# VodokanalStat

Скрипт собирает статистику по оповещениям Telegram-канала `@taganrog_vodokanal`, строит три графика и отправляет их в заданный чат или личные сообщения. Инструмент помогает отслеживать активность по дням и часам, а также приблизительные сроки завершения ремонтных работ.

## Что делает скрипт

- загружает историю публикаций за последние N дней;
- фильтрует служебные посты с тегами `#полезное` и `#статистика` и другие нерелевантные сообщения;
- строит графики:
  - количество уведомлений по дням;
  - частоту публикаций по часам;
  - распределение указанных в тексте временных меток;
- сохраняет графики в файлы `stat.png`, `stat_by_hour.png`, `stat_by_parsed_hour.png`;
- формирует текстовый отчёт и отправляет всё одним сообщением через Telegram.

## Требования

- Python
- Telegram API ID и API Hash (получаются на [my.telegram.org](https://my.telegram.org))
- Установленные пакеты Python: `telethon`, `matplotlib`, `numpy`, `requests`, `beautifulsoup4`

## Настройка параметров

Отредактируйте значения в `main.py`:

- `api_id`, `api_hash` — ваши данные Telegram API;
- `TELEGRAM_CHANNEL` — источник данных (по умолчанию `@taganrog_vodokanal`);
- `SEND_TO` — адресат отчёта (пользователь или канал, в который бот имеет право постить).

Telethon сохранит файл сессии `data/session.session` рядом со скриптом после первого запуска. Храните его вместе с остальными файлами или переименуйте, если требуется отдельная сессия.

Переменная окружения `SEND_SILENT` может быть установлена в `true`, чтобы отправлять сообщения без уведомлений.

## Локальный запуск

### Установка зависимостей

```bash
python -m pip install -r requirements.txt
```

### Запуск скрипта

```bash
python main.py
```

## Запуск в Docker (так же Podman)

Получение сессии и однократный запуск для аутентификации:

```bash
docker run -it --rm \
  --env-file .env \
  -v "$(pwd)/data:/app/data:Z" \
  ghcr.io/serega404/vodokanalstat:main python3 /app/main.py --auth
```

Запуск:

```bash
docker compose up -d
```

Контейнер запускает `crond`, который исполняет скрипт каждую неделю и месяц (см. [crontab](./crontab)).

## Полезно знать

- Скрипт опирается на точность дат и текстовых отметок времени в публикациях. Возможны погрешности в графике «Время до завершения ремонта».
- Если Telegram возвращает слишком большой поток сообщений, уменьшите параметр `days_count`.
- Чтобы адаптировать проект под другой канал, достаточно изменить идентификаторы и, при необходимости, уточнить фильтрующие теги.

## Лицензия

Распространяется под лицензией MIT. Дополнительные сведения смотрите в файле [`LICENSE`](./LICENSE).
